{% load i18n %}

<form role="form" class="edit-variable-form" method="post" action="{{form_url}}">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">{% trans 'Stäng' %}</span></button>
        <h4 class="modal-title">{{modal_title}}</h4>
      </div>
      <div class="modal-body">
        {% csrf_token %}
        <span class="text-danger errors all"></span>
        {% if mode == 'create' %}
          <div class="form-group key" data-field="key">
             <label for="id_key">{% trans "Nyckel (unik)" %}</label>
             <span class="text-danger form-validation after"></span>
             {{form.key}}
             <span class="glyphicon glyphicon-remove form-control-feedback"></span>
          </div>
        {% endif %}
        <div class="form-group question" data-field="question">
            <label for="id_question">{% trans "Formulärfråga" %}</label>
            <span class="text-danger form-validation after"></span>
            {{form.question}}
            <span class="glyphicon glyphicon-remove form-control-feedback"></span>
        </div>
        <div class="form-group question_part" data-field="question_part">
            <label for="id_question_part">{% trans "Delfråga" %}</label>
            <span class="text-danger form-validation after"></span>
            {{form.question_part}}
            <span class="glyphicon glyphicon-remove form-control-feedback"></span>
        </div>
        <div class="form-group category" data-field="category">
            <label for="id_category">{% trans "Huvudgrupp" %}</label>
            <span class="text-danger form-validation after"></span>
            {{form.category}}
            <span class="glyphicon glyphicon-remove form-control-feedback"></span>
        </div>
        <div class="form-group sub_category" data-field="sub_category">
            <label for="id_sub_category">{% trans "Undergrupp" %}</label>
            <span class="text-danger form-validation after"></span>
            {{form.sub_category}}
            <span class="glyphicon glyphicon-remove form-control-feedback"></span>
        </div>
        <div class="form-group type" data-field="type">
            <label>{% trans "Enhet" %}</label>
            <span class="text-danger form-validation after"></span>
            <div>
              {% for type_choice in form.type %}
                <label class="radio-inline">
                    {{type_choice.tag}}
                    {{type_choice.choice_label}}
                </label>
              {% endfor %}
            </div>
        </div>
        <div class="form-group is_public" data-field="is_public">
            <label>{% trans "Synlighet" %}</label>
            <span class="text-danger form-validation after"></span>
            <div class="checkbox">
              {{form.is_public}}
              {% trans "Termen visas som öppen data" %}
            </div>
        </div>
        <div class="form-group target_groups" data-field="target_groups">
            <label>{% trans "Bibliotekstyper" %}</label>
            <span class="text-danger form-validation after"></span>
            <div>
              {% for target_group in form.target_groups %}
                <label class="checkbox-inline">
                  {{target_group.tag}}
                  {{target_group.choice_label}}
                </label>
              {% endfor %}
            </div>
        </div>
        <div class="form-group description" data-field="description">
            <label for="description">{% trans "Beskrivning" %}</label>
            <span class="text-danger form-validation after"></span>
            {{form.description}}
            <span class="glyphicon glyphicon-remove form-control-feedback"></span>
        </div>
        <div class="form-group comment" data-field="comment">
            <label for="comment">{% trans "Kommentar (visas ej publikt)" %}</label>
            <span class="text-danger form-validation after"></span>
            {{form.comment}}
            <span class="glyphicon glyphicon-remove form-control-feedback"></span>
        </div>
      </div>
      
      <div class="modal-footer">
        <button type="button" class="btn btn-default" data-dismiss="modal" >{% trans "Avbryt" %}</button>
        <input type="submit" class="btn btn-primary" value="{% if mode == 'create' or form.instance.is_draft %}Spara ukast{% else %}Spara ändringar{% endif %}" />
      </div>
      
    </div>
  </div>
</form>

<script type="text/javascript">
$(document).ready(function() { 
	$('.edit-variable-form').submit(function(event) {
		event.preventDefault();
		
		var self = this;
		$(self).find(".form-group").removeClass("has-feedback has-error");
		$(self).find(".form-validation").text("");
	    
		$.ajax({ 
	    	type: $(this).attr('method'), 
	        url: this.action, 
	        data: $(this).serialize(),
	        context: this,
	        success: function(data, status) {
	        	if(data.errors) {
	        		$(".form-group").each(function() {
	        			var field = $(this).attr("data-field")
	        			if(data.errors.hasOwnProperty(field)) {
	        				$(this).addClass("has-feedback has-error");
	        				$(this).find(".form-validation").text(data.errors[field]);
	        			}
	        		})
	        	} else {
    	            console.info("saved variable: ", data);
    	            $('#variableModal').modal('hide');
    	            window.location.reload(true);
	        	}
	        }, 
	        error: function(data, status) {
	        	console.info("An error occured while saving variable!")
	        }
	    });
	    return false;
	});
});
</script>
